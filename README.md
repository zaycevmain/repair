# Реестр поломок / ремонта

Система учёта поломок оборудования с внесением заявок через сканирование ШК/QR в браузере (в т.ч. на iPhone, iPad, Android).

![Screenshot](https://github.com/zaycevmain/repair/blob/main/pic.png)

---

## Возможности

### Операторы
- Вход по **6-значному пин-коду**
- Сканирование ШК/QR камерой телефона или сканером
- Внесение поломки: место, описание, метод воспроизведения
- **Фото к поломке** — сжатие на сервере, поддержка **HEIC (iPhone)**
- Просмотр своих заявок

### Администраторы и инженеры
- Вход по **логину и паролю**
- **Реестр поломок** — просмотр, смена статуса, удаление (только админ)
- **Номенклатура** — добавление, импорт из Excel/CSV, удаление (только админ). Инженер — только просмотр
- **Метрики** и **календарь**
- Уведомления: **почта** и **Telegram** при новой поломке, ремонте, закрытии, повторном открытии

### Администраторы (дополнительно)
- **Пользователи** — создание, импорт из CSV, блокировка, удаление
- Кнопка «Отправить пин на почту» для операторов
- **Шаблоны писем** и **шаблоны Telegram** (HTML-форматирование)
- **Настройки** — SMTP, уведомления, Telegram

### Техническое
- Автосжатие фото при загрузке (ресайз до 1920px, JPEG 85%)
- HEIC → JPEG в браузере для iPhone
- Поддержка WEB_ROOT в корне домена или подпапке

---

## Требования

| Компонент | Версия |
|-----------|--------|
| PHP | 7.4+ (рекомендуется 8.0+) |
| MySQL / MariaDB | 5.7+ |
| Расширения PHP | `pdo_mysql`, `gd`, `zip`, `mbstring`, `fileinfo`, `json` |

- **gd** — для сжатия фото
- **zip** — для импорта XLSX
- **mbstring**, **fileinfo**, **json** — обычно включены по умолчанию

---

## Установка через веб-установщик

1. Скопируйте проект на сервер.
2. Откройте в браузере: `http://ваш-сайт/repair/install.php` (или `http://ваш-сайт/install.php`, если проект в корне).
3. Заполните форму:
   - **Хост MySQL** — обычно `localhost`
   - **Порт** — 3306
   - **Имя базы** — будет создана автоматически
   - **Пользователь и пароль** MySQL
   - **Путь к сайту (WEB_ROOT)** — оставьте **пустым**, если сайт в корне домена; укажите `/repair`, если проект в папке `/repair`
4. Нажмите **Установить**.
5. **Удалите файл `install.php`** после успешной установки.

**Первый вход:** иконка замка → логин **admin**, пароль **admin**. Сразу смените пароль в Настройках.

---

## Установка вручную

### 1. База данных

```bash
mysql -u root -p -e "CREATE DATABASE repair CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
mysql -u root -p repair < sql/schema.sql
```

### 2. Конфигурация

Создайте `config.local.php`:

```php
<?php
$db = [
    'host' => 'localhost',
    'port' => 3306,
    'dbname' => 'repair',
    'user' => 'ваш_пользователь',
    'pass' => 'ваш_пароль',
    'charset' => 'utf8mb4',
];
$webRoot = ''; // пусто — корень, или '/repair' для подпапки
```

### 3. Зависимости (Composer)

```bash
cd /path/to/repair
composer install
```

Требуется для импорта номенклатуры из **XLSX**. Импорт **CSV** работает без Composer.

### 4. Права на каталог загрузок

```bash
chmod 755 uploads uploads/breakdowns
# или при необходимости:
chown www-data:www-data uploads uploads/breakdowns
```

### 5. Виртуальный хост (Apache)

DocumentRoot должен указывать на каталог с `index.php` и остальными файлами проекта.

---

## Установка в Docker

В проекте есть готовые `Dockerfile` и `docker-compose.yml`.

### Запуск

```bash
docker-compose up -d
```

- Веб-интерфейс: **http://localhost:8080**
- MySQL: порт 3306 (логин `repair` / пароль `repairpass`, БД `repair`)

После первого запуска:
1. Откройте `http://localhost:8080/install.php`
2. В форме укажите:
   - **Хост MySQL:** `mysql`
   - **Порт:** 3306
   - **БД:** repair
   - **Пользователь/пароль:** repair / repairpass
   - **WEB_ROOT:** оставьте пустым (корень) или укажите путь
3. Удалите `install.php` после установки.

### Что важно для Docker

| Расширение | Зачем | Как установить |
|------------|-------|----------------|
| **gd** | Сжатие фото | `docker-php-ext-configure gd --with-jpeg --with-webp --with-png` + `docker-php-ext-install gd` |
| **zip** | Импорт XLSX | `docker-php-ext-install zip` |
| **pdo_mysql** | База данных | `docker-php-ext-install pdo_mysql` |

Проверка расширений внутри контейнера:

```bash
docker exec -it <имя_контейнера> php -m
```

---

## Структура проекта

```
repair/
├── Dockerfile           # Образ PHP с GD, ZIP
├── docker-compose.yml   # App + MySQL
├── config.php           # Основной конфиг
├── config.local.php     # Локальные настройки (создаётся install)
├── index.php            # Страница входа
├── operator.php         # Кабинет оператора
├── install.php          # Веб-установщик (удалить после установки)
├── admin/
│   ├── index.php        # Админка
│   ├── breakdown.php    # Карточка поломки
│   └── tab_*.php        # Вкладки: registry, nomenclature, users, settings, metrics, calendar
├── api/
│   ├── check_barcode.php   # Проверка ШК по номенклатуре
│   ├── save_breakdown.php  # Сохранение поломки
│   └── upload_photo.php    # Загрузка фото (со сжатием)
├── includes/
│   ├── Db.php, Auth.php, Mailer.php, Telegram.php
│   ├── ExcelImport.php, helpers.php
├── assets/
│   ├── css/common.css
│   └── js/operator.js, admin.js
├── sql/
│   └── schema.sql       # Схема БД
└── uploads/breakdowns/  # Загруженные фото
```

---

## Роли и права

| Действие | Оператор | Инженер | Админ |
|----------|----------|---------|-------|
| Вносить поломки | ✓ | — | — |
| Просмотр реестра, номенклатуры | — | ✓ | ✓ |
| Смена статуса поломки | — | ✓ | ✓ |
| Удаление поломки | — | — | ✓ |
| Добавление/импорт/удаление номенклатуры | — | — | ✓ |
| Пользователи, настройки, шаблоны | — | — | ✓ |

---

## Сканирование (iOS, Android)

Используется библиотека [html5-qrcode](https://github.com/mebjas/html5-qrcode). Поддерживаются QR, EAN-13, Code 128, Data Matrix и др.

- **iPhone:** разрешите доступ к камере при первом запросе.
- **Safari:** настройки сайта → Камера — разрешено.

---

## Фото к поломкам

- **Форматы:** JPG, PNG, GIF, WebP, **HEIC (iPhone)**
- **Сжатие:** автоматическое (ресайз до 1920px, JPEG 85%). ~2 МБ → ~100–200 КБ.
- **HEIC:** конвертируется в JPEG в браузере перед отправкой.

---

## Уведомления

### Почта
В Настройках укажите SMTP (например Gmail, Yandex) и списки email для: новая поломка, выполнен ремонт, повторно открыта задача.

### Telegram
Укажите токен бота и chat_id группы/канала. Можно редактировать шаблоны сообщений (HTML: `<b>`, `<i>`, `<code>`).

### Шаблоны
- **Письма:** тема и тело для каждого типа события (новая поломка, ремонт, закрыто, повторно открыта).
- **Письмо с пин-кодом** — при отправке пин-кода оператору на почту.
- **Telegram** — текст сообщений с подстановкой полей `{object}`, `{inventory_number}`, `{description}` и др.

---

## Решение проблем

### «Headers already sent»
Убедитесь, что в `config.php` есть `ob_start()` в начале и обновлённый `helpers.php` (функция `redirect` очищает буфер).

### «Class ZipArchive not found»
Установите расширение **zip**:
```bash
# Ubuntu/Debian
sudo apt install php-zip

# Docker
docker-php-ext-install zip
```

### «Class 'ZipArchive' not found» при импорте XLSX
То же — нужен `php-zip` в контейнере.

### «Parse error: unexpected '|'» в vendor
Версия PHP ниже 8.0. Обновите до PHP 8.0+ или понизьте версии пакетов в `composer.json`.

### «Class 'ZipArchive' not found» / «GD not found» в Docker
Добавьте в Dockerfile установку расширений (см. раздел «Установка в Docker»).

### HEIC не загружается
Убедитесь, что подключён скрипт `heic2any` в `operator.php` и `accept` у input включает `image/heic,image/heif,.heic,.heif`.

### WEB_ROOT
Если проект в корне — оставьте `$webRoot = ''` в `config.local.php`. При установке через install.php оставьте поле «Путь к сайту» пустым.

---

## Лицензия

Проект для внутреннего использования.
